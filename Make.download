# -*- makefile -*-
info ::
	@echo
	@echo "================ tar/zip file download:"
	@echo "make download untar/unpack [ TGZURL=... ] [ ZIPURL=... ]"
.PHONY: download untar unpack retar
download :: homedir
	@( \
	source ${MAKEINCLUDES}/names.sh \
	 && setnames "${PACKAGEROOT}" "${PACKAGE}" "${PACKAGEVERSION}" "${INSTALLEXT}" "${PACKAGEBASENAME}" \
	 && echo "Dowload starting for $${package}-${PACKAGEVERSION} in `pwd`" \
	 && if [ ! -z "${DOWNLOADPATH}" ] ; then \
	    cd "${DOWNLOADPATH}" ; else cd $$homedir ; fi \
	 && if [ ! -z "${TGZRENAME}" ] ; then \
	        export tgz=$$( echo "${TGZRENAME}"  | cut -d' ' -f 3 ) \
	    ; else \
	        export tgz="${TGZURL}" && export tgz="$${tgz##*/}" \
	    ; fi \
	 && rm -rf $$tgz $${package}-${PACKAGEVERSION} \
	 && if [ ! -z "${ZIPURL}" ] ; then \
	        wget ${ZIPURL} ; else wget ${TGZURL} ; fi \
	 && if [ ! -z "${TGZRENAME}" ] ; then \
	        echo " .. rename: ${TGZRENAME}" \
	         && eval ${TGZRENAME}  ; fi \
	)
unpack untar :: 
	@( \
	source ${MAKEINCLUDES}/names.sh \
	 && setnames "${PACKAGEROOT}" "${PACKAGE}" "${PACKAGEVERSION}" "${INSTALLEXT}" "${PACKAGEBASENAME}" \
	 && echo "Unpacking tar file for $${package}-${PACKAGEVERSION}" \
	 && if [ ! -z "${DOWNLOADPATH}" ] ; then \
	    cd "${DOWNLOADPATH}" ; else cd $$homedir ; fi \
	 && if [ ! -z "${TGZRENAME}" ] ; then \
	        tgz=` echo "${TGZRENAME}"  | cut -d' ' -f 3` \
	    ; else \
	        tgz=${TGZURL} && tgz=$${tgz##*/} \
	    ; fi \
	 && if [ ! -z "${ZIPURL}" ] ; then \
	        unpackdir=$$( unzip -l $$tgz | sed -n -e '5p' | awk '{print $$4}' ) \
	         && unpackdir=$${unpackdir%%/*} \
	         && echo " .. zip file <<$$tgz>> contains: $$unpackdir; unpacking" \
	         && rm -rf $$unpackdir \
	         && unzip $$tgz \
	    ; else \
	        unpackdir=$$( tar ftz $$tgz | head -n 1 ) \
	         && unpackdir=$${unpackdir%%/} \
	         && echo " .. tar file <<$$tgz>> contains: $$unpackdir; unpacking" \
	         && rm -rf $$unpackdir \
	         && tar fxz $$tgz \
	    ; fi \
	 && echo " .. done unpacking" \
	 && packagedir=$${packagebasename}-${PACKAGEVERSION} \
	 && if [ ! "$${unpackdir}" = "$${packagedir}" ] ; then \
	        echo " .. move to $${packagedir}" \
	         && rm -rf $${packagedir} \
	         && mv $${unpackdir} $${packagedir} \
	        ; \
	    fi \
	 && if [ ! -z "${BOOTSTRAP}" ] ; then \
	        echo ".. bootstrapping" \
	         && ( cd $${packagedir} && eval ${BOOTSTRAP} ) \
	    ; fi \
	 && echo "unpacked: $${packagedir}" \
	 && ls \
	) 2>&1 | tee untar.log

retar :
	@\
	source ${MAKEINCLUDES}/names.sh \
	 && setnames "${PACKAGEROOT}" "${PACKAGE}" "${PACKAGEVERSION}" "${INSTALLEXT}" "${PACKAGEBASENAME}" \
	 && echo "Repacking tar file for $${package}-${PACKAGEVERSION}" \
	 && if [ ! -z "${DOWNLOADPATH}" ] ; then \
	    cd "${DOWNLOADPATH}" ; else cd $$homedir ; fi \
	 && tgz=${TGZURL} && tgz=$${tgz##*/} \
	 && packagedir=$${packagebasename}-${PACKAGEVERSION} \
	 && if [ $$tgz != $$packagedir ] ; then \
	      unpackdir=$$( tar ftz $$tgz | head -n 1 ) \
	       && unpackdir=$${unpackdir%%/} \
	       && tgzname=$${packagedir}.tgz \
	       && echo "repacking $$unpackdir to: $$tgzname" \
	       && tar fcz $${tgzname} $$unpackdir \
	    ; fi
